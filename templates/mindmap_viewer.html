{% extends 'base.html' %}

{% block title %}Unit {{ unit_id }} Mindmap | 51Talk AI Learning{% endblock %}

{% block additional_css %}
<style>
    #mindmapContainer {
        width: 100%;
        height: 600px;
        background: rgba(26, 26, 31, 0.8);
        border: 1px solid rgba(107, 114, 128, 0.2);
        border-radius: 12px;
        position: relative;
        overflow: hidden;
    }

    #mindmapSvg {
        width: 100%;
        height: 100%;
        background: radial-gradient(circle at center, rgba(139, 92, 246, 0.05) 0%, rgba(26, 26, 31, 0.9) 100%);
    }

    .mindmap-controls {
        background: rgba(32, 33, 43, 0.9);
        border-radius: 8px;
        padding: 1rem;
        margin-bottom: 1rem;
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-wrap: wrap;
        gap: 1rem;
    }

    .control-group {
        display: flex;
        gap: 0.5rem;
        align-items: center;
    }

    .control-btn {
        background: rgba(107, 114, 128, 0.2);
        border: 1px solid rgba(107, 114, 128, 0.3);
        color: var(--text-color);
        padding: 0.5rem 1rem;
        border-radius: 6px;
        cursor: pointer;
        transition: all 0.3s ease;
    }

    .control-btn:hover {
        background: rgba(139, 92, 246, 0.3);
        border-color: var(--accent-purple);
    }

    .control-btn.active {
        background: var(--accent-purple);
        border-color: var(--accent-purple);
        color: white;
    }

    /* Mindmap Node Styles */
    .node-circle {
        cursor: pointer;
        transition: all 0.3s ease;
    }

    .node-circle.central {
        fill: var(--accent-purple);
        stroke: var(--purple-light);
        stroke-width: 3;
    }

    .node-circle.branch {
        fill: var(--accent-teal);
        stroke: var(--accent-cyan);
        stroke-width: 2;
    }

    .node-circle.leaf {
        fill: var(--accent-blue);
        stroke: var(--info-color);
        stroke-width: 1;
    }

    .node-circle:hover {
        filter: brightness(1.3);
        stroke-width: 4;
    }

    .node-text {
        fill: var(--text-color);
        font-size: 12px;
        font-weight: 500;
        text-anchor: middle;
        pointer-events: none;
        font-family: 'Inter', sans-serif;
    }

    .node-text.central {
        font-size: 16px;
        font-weight: 700;
        fill: white;
    }

    .node-text.branch {
        font-size: 14px;
        font-weight: 600;
    }

    .link {
        fill: none;
        stroke: rgba(107, 114, 128, 0.6);
        stroke-width: 2;
        transition: all 0.3s ease;
    }

    .link:hover {
        stroke: var(--accent-purple);
        stroke-width: 3;
    }

    /* Info Panel */
    .info-panel {
        position: absolute;
        top: 20px;
        right: 20px;
        background: rgba(32, 33, 43, 0.95);
        border: 1px solid rgba(139, 92, 246, 0.3);
        border-radius: 8px;
        padding: 1rem;
        max-width: 300px;
        display: none;
        backdrop-filter: blur(10px);
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
    }

    .info-panel h5 {
        color: var(--accent-purple);
        margin-bottom: 0.5rem;
    }

    .info-panel p {
        color: var(--text-color);
        font-size: 0.9rem;
        margin-bottom: 0.5rem;
    }

    .expand-btn {
        background: var(--gradient-purple);
        color: white;
        border: none;
        border-radius: 6px;
        padding: 0.5rem 1rem;
        font-size: 0.8rem;
        cursor: pointer;
        transition: all 0.3s ease;
    }

    .expand-btn:hover {
        transform: translateY(-1px);
        box-shadow: 0 4px 10px rgba(139, 92, 246, 0.3);
    }

    .expand-btn:disabled {
        opacity: 0.6;
        cursor: not-allowed;
        transform: none;
    }

    /* Loading Animation */
    .loading-node {
        animation: pulse 1.5s ease-in-out infinite;
    }

    @keyframes pulse {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.5; }
    }

    /* Legend */
    .legend {
        background: rgba(32, 33, 43, 0.8);
        border-radius: 8px;
        padding: 1rem;
        margin-top: 1rem;
    }

    .legend-item {
        display: flex;
        align-items: center;
        margin-bottom: 0.5rem;
    }

    .legend-circle {
        width: 16px;
        height: 16px;
        border-radius: 50%;
        margin-right: 0.75rem;
    }

    .legend-text {
        color: var(--text-color);
        font-size: 0.9rem;
    }

    /* Error Display Styles */
    .mindmap-error {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        min-height: 400px;
        padding: 2rem;
        text-align: center;
        color: var(--text-color);
    }

    .error-icon {
        font-size: 4rem;
        margin-bottom: 1rem;
        color: var(--warning-color);
        animation: pulse 2s infinite;
    }

    .error-actions {
        display: flex;
        gap: 1rem;
        flex-wrap: wrap;
        justify-content: center;
        margin: 2rem 0;
    }

    .error-actions button,
    .error-actions a {
        padding: 0.75rem 1.5rem;
        border: none;
        border-radius: 8px;
        font-size: 1rem;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.3s ease;
        text-decoration: none;
        display: inline-block;
    }

    .btn-retry {
        background: #4CAF50;
        color: white;
    }

    .btn-retry:hover {
        background: #45a049;
        transform: translateY(-2px);
    }

    .btn-clear {
        background: #2196F3;
        color: white;
    }

    .btn-clear:hover {
        background: #1976D2;
        transform: translateY(-2px);
    }

    .btn-back {
        background: #FF9800;
        color: white;
    }

    .btn-back:hover {
        background: #F57C00;
        transform: translateY(-2px);
    }

    /* Debug styles */
    .debug-info {
        background: rgba(26, 26, 31, 0.8);
        border: 1px solid rgba(139, 92, 246, 0.3);
        border-radius: 8px;
        padding: 1rem;
        margin-top: 1rem;
        font-family: monospace;
        font-size: 0.8rem;
        width: 100%;
        max-width: 600px;
    }

    .debug-info details {
        margin-top: 1rem;
    }

    .debug-info summary {
        cursor: pointer;
        padding: 0.5rem;
        background: rgba(255, 255, 255, 0.1);
        border-radius: 4px;
        margin-bottom: 1rem;
        font-weight: 500;
    }

    .debug-info pre {
        background: rgba(0, 0, 0, 0.3);
        padding: 1rem;
        border-radius: 8px;
        text-align: left;
        font-size: 0.75rem;
        overflow-x: auto;
        white-space: pre-wrap;
        word-wrap: break-word;
        color: var(--text-color);
    }

    .error-solutions {
        background: rgba(32, 33, 43, 0.8);
        border: 1px solid rgba(20, 184, 166, 0.3);
        border-radius: 8px;
        padding: 1rem;
        margin-top: 1rem;
        text-align: left;
        width: 100%;
        max-width: 600px;
    }

    .error-solutions h6 {
        color: var(--accent-teal);
        margin-bottom: 0.5rem;
    }

    .error-solutions ul {
        color: var(--text-color);
        font-size: 0.9rem;
        margin: 0;
        padding-left: 1.5rem;
    }

    .error-solutions li {
        margin-bottom: 0.5rem;
    }

    /* Loading States */
    .mindmap-loading {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        text-align: center;
        color: var(--text-color);
    }

    .loading-spinner {
        border: 4px solid rgba(255, 255, 255, 0.1);
        border-top: 4px solid var(--accent-purple);
        border-radius: 50%;
        width: 50px;
        height: 50px;
        animation: spin 1s linear infinite;
        margin: 0 auto 1rem;
    }

    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }

    /* Responsive Design */
    @media (max-width: 768px) {
        .mindmap-error {
            margin: 1rem;
            padding: 1.5rem 1rem;
        }
        
        .error-actions {
            flex-direction: column;
            align-items: center;
        }
        
        .error-actions button,
        .error-actions a {
            width: 100%;
            max-width: 200px;
        }
        
        .mindmap-controls {
            flex-direction: column;
            gap: 0.5rem;
        }
        
        .control-group {
            width: 100%;
            justify-content: center;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-md-12">
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <h2><i class="fas fa-project-diagram mr-2" style="color: var(--accent-purple);"></i>Unit {{ unit_id }} 
                {% if content_type == 'word' %}
                    <span style="color: var(--accent-teal);">Vocabulary</span>
                {% else %}
                    Materials
                {% endif %}
                Mindmap</h2>
                <p class="text-muted">Interactive AI-generated {{ content_label }} mindmap for {{ user_camp }} camp</p>
                <span class="badge badge-{% if content_type == 'word' %}info{% else %}primary{% endif %} mr-2">
                    <i class="fas fa-{% if content_type == 'word' %}spell-check{% else %}file-alt{% endif %} mr-1"></i>
                    {{ content_count }} {{ content_label.title() }}
                </span>
            </div>
            <div>
                <a href="{{ url_for('mindmap_home') }}" class="btn btn-secondary mr-2">
                    <i class="fas fa-arrow-left mr-1"></i> Back to Selection
                </a>
                <a href="{{ url_for('unit', unit_id=unit_id) }}" class="btn btn-primary">
                    <i class="fas fa-book mr-1"></i> View Unit Materials
                </a>
            </div>
        </div>
    </div>
</div>

<!-- Mindmap Controls -->
<div class="mindmap-controls">
    <div class="control-group">
        <button class="control-btn active" id="zoomFit" onclick="resetZoom()">
            <i class="fas fa-expand-arrows-alt mr-1"></i> Fit to Screen
        </button>
        <button class="control-btn" id="zoomIn" onclick="zoomIn()">
            <i class="fas fa-search-plus mr-1"></i> Zoom In
        </button>
        <button class="control-btn" id="zoomOut" onclick="zoomOut()">
            <i class="fas fa-search-minus mr-1"></i> Zoom Out
        </button>
    </div>
    
    <div class="control-group">
        <button class="control-btn" id="refreshMindmap" onclick="regenerateMindmap()">
            <i class="fas fa-sync-alt mr-1"></i> Regenerate
        </button>
        <button class="control-btn" id="clearCache" onclick="clearMindmapCache()">
            <i class="fas fa-trash mr-1"></i> Clear Cache
        </button>
        <button class="control-btn" id="debugBtn" onclick="debugMindmap()">
            <i class="fas fa-bug mr-1"></i> Debug
        </button>
        <button class="control-btn" id="fullscreen" onclick="toggleFullscreen()">
            <i class="fas fa-expand mr-1"></i> Fullscreen
        </button>
    </div>
</div>

<!-- Mindmap Container -->
<div class="row">
    <div class="col-md-9">
        <div id="mindmapContainer">
            <svg id="mindmapSvg"></svg>
            
            <!-- Info Panel -->
            <div id="infoPanel" class="info-panel">
                <h5 id="nodeTitle">Node Title</h5>
                <p id="nodeDescription">Click on nodes to explore more details...</p>
                <button class="expand-btn" id="expandNode" onclick="expandCurrentNode()">
                    <i class="fas fa-plus mr-1"></i> Expand Node
                </button>
            </div>
            
            <!-- Loading Indicator -->
            <div id="mindmapLoading" class="mindmap-loading" style="display: none;">
                <div class="loading-spinner"></div>
                <p class="mt-2">Loading mindmap...</p>
                <small class="text-muted">Analyzing content and generating visualization...</small>
            </div>
        </div>
    </div>
    
    <div class="col-md-3">
        <!-- Legend -->
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-info-circle mr-2"></i>Legend</h5>
            </div>
            <div class="card-body">
                <div class="legend">
                    <div class="legend-item">
                        <div class="legend-circle" style="background: var(--accent-purple);"></div>
                        <span class="legend-text">Central Topic</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-circle" style="background: var(--accent-teal);"></div>
                        <span class="legend-text">Main Concepts</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-circle" style="background: var(--accent-blue);"></div>
                        <span class="legend-text">Details & Examples</span>
                    </div>
                </div>
                
                <hr style="border-color: rgba(107, 114, 128, 0.2);">
                
                <h6 style="color: var(--text-color); margin-bottom: 1rem;">Instructions:</h6>
                <ul style="color: var(--accent-gray); font-size: 0.85rem;">
                    <li>Click nodes to see details</li>
                    <li>Drag to pan around</li>
                    <li>Use mouse wheel to zoom</li>
                    <li>Click "Expand" to generate more details</li>
                    {% if content_type == 'word' %}
                    <li>Explore vocabulary relationships</li>
                    {% else %}
                    <li>Discover concept connections</li>
                    {% endif %}
                </ul>
            </div>
        </div>
        
        <!-- Stats -->
        <div class="card mt-3">
            <div class="card-header">
                <h5><i class="fas fa-chart-bar mr-2"></i>Mindmap Stats</h5>
            </div>
            <div class="card-body">
                <div class="stat-item">
                    <i class="fas fa-circle" style="color: var(--accent-purple);"></i>
                    <div>
                        <div class="stat-number" id="totalNodes">0</div>
                        <div class="stat-label">Total Nodes</div>
                    </div>
                </div>
                <div class="stat-item">
                    <i class="fas fa-{% if content_type == 'word' %}spell-check{% else %}file-alt{% endif %}" style="color: var(--accent-teal);"></i>
                    <div>
                        <div class="stat-number">{{ content_count }}</div>
                        <div class="stat-label">Source {{ content_label.title() }}</div>
                    </div>
                </div>
                <div class="stat-item">
                    <i class="fas fa-tag" style="color: var(--accent-blue);"></i>
                    <div>
                        <div class="stat-number">{{ content_type.title() }}</div>
                        <div class="stat-label">Content Type</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Debug Info Card -->
        <div class="card mt-3">
            <div class="card-header">
                <h5><i class="fas fa-wrench mr-2"></i>Debug Info</h5>
            </div>
            <div class="card-body">
                <small style="color: var(--accent-gray);">
                    <strong>Unit:</strong> {{ unit_id }}<br>
                    <strong>Type:</strong> {{ content_type }}<br>
                    <strong>Camp:</strong> {{ user_camp }}<br>
                    <strong>User ID:</strong> {{ session.user_id }}<br>
                    <button class="btn btn-sm btn-outline-info mt-2" onclick="checkSystemStatus()">
                        <i class="fas fa-stethoscope mr-1"></i> Check System
                    </button>
                    <button class="btn btn-sm btn-outline-warning mt-2" onclick="validateCurrentMindmap()">
                        <i class="fas fa-check-circle mr-1"></i> Validate Data
                    </button>
                </small>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://d3js.org/d3.v7.min.js"></script>
<script>
// Mindmap variables
let mindmapData = null;
let svg, g, simulation;
let currentSelectedNode = null;
let zoom;

// Initialize mindmap on page load
document.addEventListener('DOMContentLoaded', function() {
    console.log('üéØ Mindmap viewer initialized', {
        unitId: {{ unit_id }},
        contentType: new URLSearchParams(window.location.search).get('content_type') || 'material',
        userCamp: '{{ user_camp }}',
        timestamp: new Date().toISOString()
    });
    
    initializeMindmap();
    loadMindmapData();
});

function initializeMindmap() {
    const container = d3.select("#mindmapContainer");
    const width = container.node().getBoundingClientRect().width;
    const height = container.node().getBoundingClientRect().height;
    
    svg = d3.select("#mindmapSvg")
        .attr("width", width)
        .attr("height", height);
    
    // Add zoom behavior
    zoom = d3.zoom()
        .scaleExtent([0.1, 4])
        .on("zoom", (event) => {
            g.attr("transform", event.transform);
        });
    
    svg.call(zoom);
    
    // Main group for all mindmap elements
    g = svg.append("g");
    
    // Add drag behavior to svg for panning
    svg.on("click", function(event) {
        if (event.target === this) {
            hideInfoPanel();
        }
    });
}

function validateMindmapData(data) {
    if (!data || typeof data !== 'object') {
        console.error('‚ùå Mindmap data is not an object:', data);
        return false;
    }
    
    if (!data.central_topic) {
        console.error('‚ùå Mindmap missing central_topic:', data);
        return false;
    }
    
    if (!Array.isArray(data.branches)) {
        console.error('‚ùå Mindmap branches is not an array:', data.branches);
        return false;
    }
    
    for (let i = 0; i < data.branches.length; i++) {
        const branch = data.branches[i];
        if (!branch || typeof branch !== 'object') {
            console.error(`‚ùå Branch ${i} is not an object:`, branch);
            return false;
        }
        if (!branch.name) {
            console.error(`‚ùå Branch ${i} missing name:`, branch);
            return false;
        }
        if (branch.children && !Array.isArray(branch.children)) {
            console.error(`‚ùå Branch ${i} children is not an array:`, branch.children);
            return false;
        }
    }
    
    console.log('‚úÖ Mindmap data validation passed');
    return true;
}

function loadMindmapData() {
    showLoading();
    
    // Get content type from URL parameters
    const urlParams = new URLSearchParams(window.location.search);
    const contentType = urlParams.get('content_type') || 'material';
    
    console.log('üß† MINDMAP DEBUG: Loading', { 
        unitId: {{ unit_id }}, 
        contentType,
        userCamp: '{{ user_camp }}',
        userId: {{ session.user_id }}
    });
    
    // Check if mindmap data is already cached
    const cacheKey = `mindmap_unit_{{ unit_id }}_${contentType}`;
    const cachedData = sessionStorage.getItem(cacheKey);
    if (cachedData) {
        console.log('üíæ Found cached data, validating...');
        try {
            const parsedData = JSON.parse(cachedData);
            if (validateMindmapData(parsedData)) {
                console.log('‚úÖ Using valid cached data');
                mindmapData = parsedData;
                renderMindmap(mindmapData);
                hideLoading();
                return;
            } else {
                console.warn('‚ö†Ô∏è Cached data invalid, removing and fetching fresh');
                sessionStorage.removeItem(cacheKey);
            }
        } catch (e) {
            console.warn('‚ö†Ô∏è Cached data corrupted, fetching fresh:', e);
            sessionStorage.removeItem(cacheKey);
        }
    }
    
    // Load from server with content type parameter
    const apiUrl = `/api/generate_mindmap/{{ unit_id }}?content_type=${contentType}`;
    console.log('üì° API Request:', apiUrl);
    
    fetch(apiUrl)
        .then(response => {
            console.log('üì° Response status:', response.status, response.statusText);
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            return response.json();
        })
        .then(data => {
            console.log('üì° Response data:', data);
            hideLoading();
            
            if (data.success) {
                if (validateMindmapData(data.mindmap)) {
                    console.log('‚úÖ Success! Mindmap nodes:', data.mindmap?.branches?.length || 0);
                    mindmapData = data.mindmap;
                    sessionStorage.setItem(cacheKey, JSON.stringify(mindmapData));
                    renderMindmap(mindmapData);
                } else {
                    console.error('‚ùå Invalid mindmap structure received');
                    showDetailedError('Invalid mindmap data structure received from server', {
                        received_data: data.mindmap,
                        validation_failed: true
                    });
                }
            } else {
                console.error('‚ùå API Error:', data.error);
                showDetailedError(data.error || 'Failed to load mindmap', data.debug_info || null);
            }
        })
        .catch(error => {
            hideLoading();
            console.error('‚ùå Network Error:', error);
            showDetailedError(`Network error: ${error.message}`, {
                apiUrl: apiUrl,
                timestamp: new Date().toISOString(),
                userAgent: navigator.userAgent,
                errorType: 'NetworkError'
            });
        });
}

function renderMindmap(data) {
    if (!validateMindmapData(data)) {
        showDetailedError('Cannot render invalid mindmap data', { invalidData: data });
        return;
    }
    
    // Clear existing content
    g.selectAll("*").remove();
    
    console.log('üé® Rendering mindmap:', {
        centralTopic: data.central_topic,
        branchCount: data.branches.length
    });
    
    // Prepare data for D3
    const nodes = [];
    const links = [];
    
    // Central node
    const centralNode = {
        id: 'central',
        name: data.central_topic,
        type: 'central',
        x: 0,
        y: 0,
        fx: 0,
        fy: 0
    };
    nodes.push(centralNode);
    
    // Branch nodes
    data.branches.forEach((branch, branchIndex) => {
        const branchNode = {
            id: `branch_${branchIndex}`,
            name: branch.name,
            type: 'branch',
            branchIndex: branchIndex
        };
        nodes.push(branchNode);
        
        // Link to central
        links.push({
            source: 'central',
            target: `branch_${branchIndex}`
        });
        
        // Child nodes
        if (branch.children && Array.isArray(branch.children)) {
            branch.children.forEach((child, childIndex) => {
                const childNode = {
                    id: `child_${branchIndex}_${childIndex}`,
                    name: child.name,
                    type: 'leaf',
                    parent: `branch_${branchIndex}`,
                    childType: child.type || 'detail'
                };
                nodes.push(childNode);
                
                // Link to parent branch
                links.push({
                    source: `branch_${branchIndex}`,
                    target: `child_${branchIndex}_${childIndex}`
                });
            });
        }
    });
    
    console.log('üìä Mindmap stats:', {
        totalNodes: nodes.length,
        totalLinks: links.length
    });
    
    // Update stats
    document.getElementById('totalNodes').textContent = nodes.length;
    
    // Create force simulation
    simulation = d3.forceSimulation(nodes)
        .force("link", d3.forceLink(links).id(d => d.id).distance(100))
        .force("charge", d3.forceManyBody().strength(-300))
        .force("center", d3.forceCenter(0, 0))
        .force("collision", d3.forceCollide().radius(30));
    
    // Create links
    const link = g.append("g")
        .selectAll("line")
        .data(links)
        .enter().append("line")
        .attr("class", "link");
    
    // Create nodes
    const node = g.append("g")
        .selectAll("g")
        .data(nodes)
        .enter().append("g")
        .attr("class", "node")
        .call(d3.drag()
            .on("start", dragstarted)
            .on("drag", dragged)
            .on("end", dragended));
    
    // Add circles to nodes
    node.append("circle")
        .attr("class", d => `node-circle ${d.type}`)
        .attr("r", d => {
            if (d.type === 'central') return 30;
            if (d.type === 'branch') return 20;
            return 15;
        })
        .on("click", function(event, d) {
            showNodeInfo(d);
            event.stopPropagation();
        });
    
    // Add text to nodes
    node.append("text")
        .attr("class", d => `node-text ${d.type}`)
        .attr("dy", "0.35em")
        .text(d => {
            if (d.name.length > 15) {
                return d.name.substring(0, 15) + "...";
            }
            return d.name;
        });
    
    // Add title for full text on hover
    node.append("title")
        .text(d => d.name);
    
    // Update positions on simulation tick
    simulation.on("tick", () => {
        link
            .attr("x1", d => d.source.x)
            .attr("y1", d => d.source.y)
            .attr("x2", d => d.target.x)
            .attr("y2", d => d.target.y);
        
        node
            .attr("transform", d => `translate(${d.x},${d.y})`);
    });
    
    // Center the view
    setTimeout(() => {
        resetZoom();
    }, 1000);
    
    console.log('‚úÖ Mindmap rendered successfully');
}

function showNodeInfo(node) {
    currentSelectedNode = node;
    
    const panel = document.getElementById('infoPanel');
    const title = document.getElementById('nodeTitle');
    const description = document.getElementById('nodeDescription');
    
    title.textContent = node.name;
    
    let desc = `Type: ${node.type.charAt(0).toUpperCase() + node.type.slice(1)}`;
    if (node.childType) {
        desc += `\nCategory: ${node.childType}`;
    }
    description.textContent = desc;
    
    panel.style.display = 'block';
}

function hideInfoPanel() {
    document.getElementById('infoPanel').style.display = 'none';
    currentSelectedNode = null;
}

function expandCurrentNode() {
    if (!currentSelectedNode) {
        alert('Please select a node first');
        return;
    }
    
    const expandBtn = document.getElementById('expandNode');
    expandBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-1"></i> Expanding...';
    expandBtn.disabled = true;
    
    const urlParams = new URLSearchParams(window.location.search);
    const contentType = urlParams.get('content_type') || 'material';
    
    fetch('/api/expand_node', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            node_name: currentSelectedNode.name,
            unit_id: {{ unit_id }},
            content_type: contentType,
            context: mindmapData ? mindmapData.central_topic : ''
        })
    })
    .then(response => response.json())
    .then(data => {
        expandBtn.innerHTML = '<i class="fas fa-plus mr-1"></i> Expand Node';
        expandBtn.disabled = false;
        
        if (data.success) {
            // Add new nodes to mindmap
            addExpandedNodes(currentSelectedNode, data.expanded_nodes);
        } else {
            alert('Failed to expand node: ' + (data.error || 'Unknown error'));
        }
    })
    .catch(error => {
        expandBtn.innerHTML = '<i class="fas fa-plus mr-1"></i> Expand Node';
        expandBtn.disabled = false;
        console.error('Error:', error);
        alert('Failed to expand node: ' + error.message);
    });
}

function addExpandedNodes(parentNode, newNodes) {
    // For now, show an alert. In a full implementation, you would:
    // 1. Add new nodes to the data structure
    // 2. Update the simulation with new nodes and links
    // 3. Animate the new nodes appearing
    alert(`Added ${newNodes.length} new details to "${parentNode.name}"`);
    console.log('Expanded nodes:', newNodes);
}

// Control functions
function resetZoom() {
    const container = d3.select("#mindmapContainer");
    const width = container.node().getBoundingClientRect().width;
    const height = container.node().getBoundingClientRect().height;
    
    svg.transition().duration(750).call(
        zoom.transform,
        d3.zoomIdentity.translate(width / 2, height / 2).scale(0.8)
    );
}

function zoomIn() {
    svg.transition().duration(300).call(
        zoom.scaleBy, 1.5
    );
}

function zoomOut() {
    svg.transition().duration(300).call(
        zoom.scaleBy, 1 / 1.5
    );
}

function regenerateMindmap() {
    if (confirm('Regenerate the mindmap? This will create a new AI analysis.')) {
        clearMindmapCache();
        loadMindmapData();
    }
}

function clearMindmapCache() {
    const urlParams = new URLSearchParams(window.location.search);
    const contentType = urlParams.get('content_type') || 'material';
    const cacheKey = `mindmap_unit_{{ unit_id }}_${contentType}`;
    
    sessionStorage.removeItem(cacheKey);
    console.log('üóëÔ∏è Cleared cache for:', cacheKey);
    
    // Clear the mindmap display
    if (g) {
        g.selectAll("*").remove();
    }
    
    alert('Cache cleared! Click "Try Again" or regenerate the mindmap.');
}

function toggleFullscreen() {
    const container = document.getElementById('mindmapContainer');
    if (document.fullscreenElement) {
        document.exitFullscreen();
    } else {
        container.requestFullscreen();
    }
}

function validateCurrentMindmap() {
    if (!mindmapData) {
        alert('No mindmap data to validate');
        return;
    }
    
    const isValid = validateMindmapData(mindmapData);
    const stats = {
        valid: isValid,
        centralTopic: mindmapData.central_topic || 'Missing',
        branchCount: mindmapData.branches ? mindmapData.branches.length : 0,
        totalChildren: 0
    };
    
    if (mindmapData.branches) {
        stats.totalChildren = mindmapData.branches.reduce((total, branch) => {
            return total + (branch.children ? branch.children.length : 0);
        }, 0);
    }
    
    alert(`Mindmap Validation Results:
    
Valid Structure: ${isValid ? '‚úÖ Yes' : '‚ùå No'}
Central Topic: ${stats.centralTopic}
Branch Count: ${stats.branchCount}
Total Children: ${stats.totalChildren}

Check browser console for detailed information.`);
    
    console.log('üîç Mindmap validation results:', stats);
    console.log('üîç Full mindmap data:', mindmapData);
}

function debugMindmap() {
    console.log('üîß Starting mindmap debug...');
    
    const urlParams = new URLSearchParams(window.location.search);
    const contentType = urlParams.get('content_type') || 'material';
    
    const debugInfo = {
        timestamp: new Date().toISOString(),
        unitId: {{ unit_id }},
        contentType: contentType,
        userCamp: '{{ user_camp }}',
        userId: {{ session.user_id }},
        mindmapData: mindmapData,
        sessionStorage: sessionStorage.getItem(`mindmap_unit_{{ unit_id }}_${contentType}`),
        mindmapValid: mindmapData ? validateMindmapData(mindmapData) : false
    };
    
    console.log('üîß Debug Info:', debugInfo);
    
    // Test API endpoints in sequence
    Promise.resolve()
        .then(() => {
            console.log('üè• Testing health endpoint...');
            return fetch('/health');
        })
        .then(response => response.json())
        .then(health => {
            console.log('üè• Health check:', health);
            
            console.log('ü§ñ Testing AI status...');
            return fetch('/ai_status');
        })
        .then(response => response.json())
        .then(aiStatus => {
            console.log('ü§ñ AI Status:', aiStatus);
            
            console.log('üì° Testing direct API call...');
            const apiUrl = `/api/generate_mindmap/{{ unit_id }}?content_type=${contentType}`;
            return fetch(apiUrl);
        })
        .then(response => {
            console.log('üì° Direct API test:', response.status, response.statusText);
            return response.json();
        })
        .then(apiData => {
            console.log('üì° Direct API response:', apiData);
            
            const debugSummary = {
                mindmapValid: debugInfo.mindmapValid,
                apiSuccess: apiData.success,
                apiError: apiData.error || 'None',
                hasCachedData: !!debugInfo.sessionStorage,
                contentCount: {{ content_count }},
                recommendations: []
            };
            
            if (!debugSummary.apiSuccess) {
                debugSummary.recommendations.push('Check if content exists for this unit and camp');
                debugSummary.recommendations.push('Verify AI system is properly initialized');
            }
            
            if (!debugSummary.mindmapValid) {
                debugSummary.recommendations.push('Clear cache and try regenerating');
                debugSummary.recommendations.push('Check for JSON parsing errors');
            }
            
            alert(`üîß Debug Complete!

Key Findings:
- Unit: {{ unit_id }}
- Content Type: ${contentType}
- User Camp: {{ user_camp }}
- Current Mindmap Valid: ${debugSummary.mindmapValid ? '‚úÖ' : '‚ùå'}
- API Response: ${debugSummary.apiSuccess ? '‚úÖ SUCCESS' : '‚ùå FAILED'}
- Error: ${debugSummary.apiError}
- Has Cached Data: ${debugSummary.hasCachedData ? 'Yes' : 'No'}
- Content Count: {{ content_count }}

${debugSummary.recommendations.length > 0 ? 'Recommendations:\n' + debugSummary.recommendations.map(r => '‚Ä¢ ' + r).join('\n') : ''}

See browser console for complete details.`);
        })
        .catch(error => {
            console.error('üîß Debug error:', error);
            alert(`Debug encountered an error: ${error.message}\n\nCheck browser console for details.`);
        });
}

function checkSystemStatus() {
    fetch('/ai_status')
        .then(response => response.json())
        .then(data => {
            console.log('üîç System status:', data);
            
            let statusText = `AI System Status: ${data.status}\n`;
            if (data.details) {
                statusText += `Ready: ${data.details.ready}\n`;
                statusText += `Documents: ${data.details.document_count}\n`;
                if (data.details.error) {
                    statusText += `Error: ${data.details.error}\n`;
                }
            }
            
            alert(statusText);
        })
        .catch(error => {
            alert(`Error checking system status: ${error.message}`);
        });
}

// Enhanced error display function
function showDetailedError(message, debugInfo = null) {
    const container = document.getElementById('mindmapContainer');
    
    let debugInfoHtml = '';
    if (debugInfo) {
        debugInfoHtml = `
            <div class="debug-info">
                <details>
                    <summary>üîß Debug Information</summary>
                    <pre>${JSON.stringify(debugInfo, null, 2)}</pre>
                </details>
            </div>
        `;
    }
    
    container.innerHTML = `
        <div class="mindmap-error">
            <div class="error-icon">‚ö†Ô∏è</div>
            <h2>Error Loading Mindmap</h2>
            <p style="white-space: pre-line; margin-bottom: 1rem;">${message}</p>
            
            <div class="error-actions">
                <button class="btn-retry" onclick="loadMindmapData()">
                    <i class="fas fa-retry mr-1"></i> Try Again
                </button>
                <button class="btn-clear" onclick="clearMindmapCache()">
                    <i class="fas fa-trash mr-1"></i> Clear Cache
                </button>
                <button class="btn btn-info" onclick="debugMindmap()">
                    <i class="fas fa-tools mr-1"></i> Debug
                </button>
                <a href="{{ url_for('mindmap_home') }}" class="btn-back">
                    <i class="fas fa-arrow-left mr-1"></i> Back to Selection
                </a>
            </div>
            
            ${debugInfoHtml}
            
            <div class="error-solutions">
                <h6><i class="fas fa-lightbulb mr-2"></i>Possible Solutions</h6>
                <ul>
                    <li>Make sure you have {{ 'vocabulary words' if 'word' in request.args.get('content_type', 'material') else 'learning materials' }} uploaded for Unit {{ unit_id }}</li>
                    <li>Check that content is tagged for your camp: <strong>{{ user_camp }}</strong></li>
                    <li>Try switching between Materials and Vocabulary content types</li>
                    <li>Verify the AI system is running: <button class="btn btn-sm btn-outline-info" onclick="checkSystemStatus()">Check AI Status</button></li>
                    <li>Contact admin if the issue persists</li>
                </ul>
                
                <div class="mt-3">
                    <small style="color: var(--accent-gray);">
                        <strong>Debug Info:</strong> Unit {{ unit_id }}, Type: {{ 'vocabulary' if 'word' in request.args.get('content_type', 'material') else 'material' }}, Camp: {{ user_camp }}, User: {{ session.user_id }}
                    </small>
                </div>
            </div>
        </div>
    `;
}

// Drag functions
function dragstarted(event, d) {
    if (!event.active) simulation.alphaTarget(0.3).restart();
    d.fx = d.x;
    d.fy = d.y;
}

function dragged(event, d) {
    d.fx = event.x;
    d.fy = event.y;
}

function dragended(event, d) {
    if (!event.active) simulation.alphaTarget(0);
    if (d.type !== 'central') {
        d.fx = null;
        d.fy = null;
    }
}

// Utility functions
function showLoading() {
    document.getElementById('mindmapLoading').style.display = 'block';
}

function hideLoading() {
    document.getElementById('mindmapLoading').style.display = 'none';
}

// Handle window resize
window.addEventListener('resize', function() {
    if (svg) {
        const container = d3.select("#mindmapContainer");
        const width = container.node().getBoundingClientRect().width;
        const height = container.node().getBoundingClientRect().height;
        
        svg.attr("width", width).attr("height", height);
        
        // Re-center the view
        setTimeout(() => {
            resetZoom();
        }, 100);
    }
});
</script>
{% endblock %}